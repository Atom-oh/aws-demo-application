# KEDA ScaledObject for Kafka-based scaling
# Requires KEDA to be installed in the cluster
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: notification-service-scaler
  namespace: hirehub
  labels:
    app.kubernetes.io/name: notification-service
    app.kubernetes.io/component: backend
spec:
  scaleTargetRef:
    name: notification-service
  pollingInterval: 15
  cooldownPeriod: 300
  minReplicaCount: 2
  maxReplicaCount: 10
  advanced:
    restoreToOriginalReplicaCount: true
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Percent
              value: 10
              periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 15
  triggers:
    # Scale based on Kafka consumer lag
    - type: kafka
      metadata:
        bootstrapServers: "${KAFKA_BROKERS}"
        consumerGroup: notification-service-group
        topic: application.submitted
        lagThreshold: "100"
        activationLagThreshold: "10"
        offsetResetPolicy: earliest
      authenticationRef:
        name: kafka-trigger-auth
    - type: kafka
      metadata:
        bootstrapServers: "${KAFKA_BROKERS}"
        consumerGroup: notification-service-group
        topic: application.status_changed
        lagThreshold: "100"
        activationLagThreshold: "10"
        offsetResetPolicy: earliest
      authenticationRef:
        name: kafka-trigger-auth
    - type: kafka
      metadata:
        bootstrapServers: "${KAFKA_BROKERS}"
        consumerGroup: notification-service-group
        topic: resume.processed
        lagThreshold: "50"
        activationLagThreshold: "5"
        offsetResetPolicy: earliest
      authenticationRef:
        name: kafka-trigger-auth
    - type: kafka
      metadata:
        bootstrapServers: "${KAFKA_BROKERS}"
        consumerGroup: notification-service-group
        topic: match.recommended
        lagThreshold: "50"
        activationLagThreshold: "5"
        offsetResetPolicy: earliest
      authenticationRef:
        name: kafka-trigger-auth
    - type: kafka
      metadata:
        bootstrapServers: "${KAFKA_BROKERS}"
        consumerGroup: notification-service-group
        topic: interview.scheduled
        lagThreshold: "20"
        activationLagThreshold: "2"
        offsetResetPolicy: earliest
      authenticationRef:
        name: kafka-trigger-auth
---
# KEDA TriggerAuthentication for MSK/Kafka
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: kafka-trigger-auth
  namespace: hirehub
spec:
  secretTargetRef:
    - parameter: sasl
      name: hirehub-kafka-credentials
      key: KAFKA_USERNAME
    - parameter: password
      name: hirehub-kafka-credentials
      key: KAFKA_PASSWORD
