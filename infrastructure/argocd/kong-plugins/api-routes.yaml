# Kong API Routes - Path-based routing for HireHub MSA
# External: api.aws.atomai.click/v1/{service}/* → Kong → K8s Service
# Internal: Services communicate via K8s DNS (gRPC/mTLS)
---
apiVersion: configuration.konghq.com/v1
kind: KongIngress
metadata:
  name: hirehub-api-upstream
  namespace: kong
spec:
  upstream:
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 3
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3

---
# =============================================================================
# User Service Routes (/v1/users/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/users
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8080

---
# =============================================================================
# Job Service Routes (/v1/jobs/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: job-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/jobs
            pathType: Prefix
            backend:
              service:
                name: job-service
                port:
                  number: 8080

---
# =============================================================================
# Resume Service Routes (/v1/resumes/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: resume-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/resumes
            pathType: Prefix
            backend:
              service:
                name: resume-service
                port:
                  number: 8080

---
# =============================================================================
# Apply Service Routes (/v1/applies/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: apply-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/applies
            pathType: Prefix
            backend:
              service:
                name: apply-service
                port:
                  number: 8080

---
# =============================================================================
# Match Service Routes (/v1/matches/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: match-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/matches
            pathType: Prefix
            backend:
              service:
                name: match-service
                port:
                  number: 8080

---
# =============================================================================
# AI Service Routes (/v1/ai/*)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-service-ingress
  namespace: hirehub
  annotations:
    konghq.com/strip-path: "false"
    konghq.com/plugins: rate-limiting,cors,jwt-auth
    konghq.com/override: hirehub-api-upstream
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /v1/ai
            pathType: Prefix
            backend:
              service:
                name: ai-service
                port:
                  number: 8080

---
# =============================================================================
# Health Check Route (No Auth Required)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: health-ingress
  namespace: kong
  annotations:
    konghq.com/strip-path: "true"
spec:
  ingressClassName: kong
  rules:
    - http:
        paths:
          - path: /health
            pathType: Exact
            backend:
              service:
                name: kong-kong-proxy
                port:
                  number: 80
